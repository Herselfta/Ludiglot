# Ludiglot 开发原则与协作规范 (Development Principles)

本文件定义了 Ludiglot 项目的开发哲学、代码纪律以及 AI 协作规范。无论是人类开发者还是 AI 助手，在对本项目进行修改前，都必须遵守这些原则。

## 1. 核心分层架构 (Architectural Decoupling)

项目遵循严格的 **Core (内核)** vs **UI (界面)** 分离原则：

- **原则**: UI 应当是“无知”的。
- **规范**: 
  - `src/ludiglot/ui/` 下的代码仅负责展示、用户交互和 UI 状态维护。
  - **严禁**将核心业务逻辑（如哈希计算、音频策略、OCR 质量评估、数据库复杂搜索）直接写在 UI 类中。
  - 核心逻辑必须下沉到 `src/ludiglot/core/` 并在那里开发独立的服务类（如 `AudioResolver`）。
- **理由**: 确保逻辑可以被命令行工具、自动化测试和调试脚本无差别地调用，避免 GUI 和 CLI 表现不一致。

## 2. 单一事实来源 (Single Source of Truth)

- **解析逻辑**: 音频解析和路径确定的唯一入口应为 `AudioResolver` 或相关的核心 Service 模块。
- **配置一致性**: 所有模块必须通过 `AppConfig` 统一获取配置信息，严禁在各处硬编码路径。

## 3. 开发与测试纪律 (Development Discipline)

- **禁止根目录脚本**: 
  - 严禁在项目根目录下直接创建临时 `.py` 脚本。
  - 所有调试、性能测试或数据调查脚本必须存放在 `tools/` 目录下。
- **引用真实逻辑**: 
  - `tools/` 下的脚本在导入项目模块时，必须引用 `src/ludiglot/core/` 下的实际业务代码。
  - 严禁在脚本中复制粘贴业务逻辑进行局部测试，因为这会产生“测试脚本通过但业务代码依然错误”的假象。
- **变更验证**:
  - 任何对 `core` 层的重构完成后，**必须**运行 GUI 启动测试（`run.ps1`）。
  - **理由**: Python 的动态性质使得很多循环导入 (Circular Import) 错误只有在运行时（尤其是 UI 加载时）才会暴露。

## 4. AI 协作协议 (AI Cooperation Protocol)

如果您是正在处理此任务的 AI 助理：

1. **上下文优先**: 在修改代码前，优先搜索并读取 `docs/` 下的文档，尤其是 `architecture.md`。
2. **重构优先**: 如果你发现 Bug 藏在 UI 层的冗余逻辑中，请**先将其重构**到 `core` 层，然后再修复。不要在“烂摊子”上打补丁。
3. **路径使用**: 始终使用绝对路径调用工具，以确保在不同的工作目录下运行一致。

## 5. 音频处理规范 (Audio Standards)

- **性别偏好**: 必须尊重 `gender_preference` 设置。
- **角色互换**: 针对 Wuthering Waves 的主角（Rover），若缺失对应性别的 ID，逻辑层必须具备自动搜索另一性别 ID 并重试的能力。
- **优先级**: 音频候选列表必须经过性别权重排序，确保首选最符合偏好的版本。
